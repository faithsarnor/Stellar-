<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Floating AI Widget - GlamBot</title>

    <style>
        /* General Styling */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            /* Example background, replace with your site's background */
            background-color: #f4f4f4;
            color: #333;
        }

        /* Chat Button (Round Icon) */
        #chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #457b9d; /* Theme color */
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.2s ease, transform 0.3s ease;
        }

        #chat-button:hover {
            background-color: #3e6c91; /* Darker hover */
            transform: scale(1.1);
        }

        /* Chat Widget Container (Main) */
        #chat-widget {
            position: fixed;
            bottom: 90px; /* Adjusted to be above button */
            right: 20px;
            width: 320px;
            /* --- ADD A HEIGHT --- */
            height: 450px; /* Adjust as needed */
            max-height: 80vh; /* Optional: prevent it being too tall */
            /* --- End Add Height --- */
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: none; /* Initially hidden */
            flex-direction: column;
            overflow: hidden; /* Important for keeping shape */
            transition: opacity 0.3s ease, transform 0.3s ease; /* Smooth open/close */
        }

        /* Chat Header (Draggable Area) */
        #drag-area {
            background-color: #457b9d; /* Theme color */
            color: white;
            padding: 12px 16px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            flex-shrink: 0; /* Prevent header from shrinking */
        }

        /* Close Button (X in header) */
        .close-button {
            cursor: pointer;
            font-size: 20px; /* Slightly larger */
            font-weight: bold;
            color: white;
            transition: color 0.2s ease;
        }

        .close-button:hover {
            color: #dfe7ef; /* Lighter hover */
        }

        /* Chat Body (Overall container for messages and input) */
        #chat-body {
           display: flex;
           flex-direction: column;
           flex-grow: 1; /* Takes remaining space inside widget */
           overflow: hidden; /* Prevent body itself from scrolling */
           height: 100%; /* Fill parent */
        }

        /* Message Container (Scrollable Area) */
        #message-container {
            flex-grow: 1; /* Takes up available space */
            overflow-y: auto; /* Makes this part scrollable */
            padding: 15px; /* Inner padding for messages */
            display: flex;
            flex-direction: column;
            gap: 10px; /* Spacing between messages */
        }

        /* Default Welcome Message Styling */
        #default-message {
            background-color: #e9f0f4; /* Slightly different background */
            color: #1d2d44;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px; /* Space before conversation starts */
            line-height: 1.4;
            font-size: 0.9em;
            /* display: block; /* Default display */
        }

         /* Styling for dynamically added message divs */
         #message-container > div {
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
         }

         .user-message {
             background-color: #d1e7fd; /* Light blue for user */
             color: #0a58ca;
             align-self: flex-end; /* Align user messages to the right */
             margin-left: 20%;
             border-bottom-right-radius: 5px; /* Chat bubble effect */
         }

          .bot-message {
             background-color: #f8f9fa; /* Light grey for bot */
             color: #495057;
             align-self: flex-start; /* Align bot messages to the left */
             margin-right: 20%;
             border-bottom-left-radius: 5px; /* Chat bubble effect */
         }


        /* Input Area Styling */
        .input-area {
           display: flex;
           gap: 10px;
           padding: 15px; /* Consistent padding */
           border-top: 1px solid #eee; /* Separator */
           background-color: #fff; /* Ensure it's on top */
           flex-shrink: 0; /* Prevent input area from shrinking */
        }

        #chat-input {
           flex-grow: 1;
           padding: 10px;
           border: 1px solid #ccc;
           border-radius: 8px;
           font-size: 0.95em; /* Slightly smaller */
           resize: none; /* Prevents textarea resizing */
           height: 40px; /* Initial height for ~2 rows */
           line-height: 1.4;
        }

        #send-button {
           background-color: #457b9d; /* Theme color */
           color: white;
           border: none;
           padding: 0 15px; /* Adjust padding */
           border-radius: 8px;
           cursor: pointer;
           font-weight: bold;
           transition: background-color 0.2s ease;
           font-size: 0.95em;
        }

        #send-button:hover {
           background-color: #3e6c91; /* Darker hover */
        }
    </style>
</head>
<body>
    <button id="chat-button">ðŸ’¬</button>

    <div id="chat-widget">
        <div id="drag-area">
            <div>GlamBot âœ¨</div>
            <div class="close-button" onclick="document.getElementById('chat-widget').style.display = 'none'">Ã—</div>
        </div>

        <div id="chat-body">

            <div id="message-container">
                <p id="default-message">
                    Hello! I'm GlamBot, your personalized skincare assistant. Ask me anything about our products, ingredients, or get customized recommendations.
                </p>
                </div>

            <div class="input-area">
                <textarea id="chat-input" rows="2" placeholder="Ask me anything..."></textarea>
                <button id="send-button" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const chatButton = document.getElementById("chat-button");
        const chatWidget = document.getElementById("chat-widget");
        const chatInput = document.getElementById("chat-input");
        const messageContainer = document.getElementById("message-container");
        const defaultMessage = document.getElementById("default-message");
        const dragArea = document.getElementById("drag-area");

        // --- Toggle Chat Widget ---
        chatButton.addEventListener("click", () => {
            const isHidden = chatWidget.style.display === "none" || chatWidget.style.display === "";
            chatWidget.style.display = isHidden ? "flex" : "none";
            if (isHidden) {
                chatInput.focus(); // Focus input when opened
                // Scroll to bottom in case there's existing history (optional)
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }
        });

        // --- Send Message on Click ---
        // (Reference sendMessage function below)

        // --- Send Message on Enter Key ---
        chatInput.addEventListener("keypress", (e) => {
            // Check if Enter key is pressed without Shift key
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent default textarea line break
                sendMessage();
            }
        });

        // --- Send Message Function ---
        function sendMessage() {
            const input = chatInput.value.trim();
            if (!input) return; // Do nothing if input is empty

            // Hide the default message if it's currently visible
            if (defaultMessage && defaultMessage.style.display !== 'none') {
                defaultMessage.style.display = 'none';
            }

            chatInput.value = ""; // Clear the input field

            // --- Display User message ---
            const userMsgDiv = document.createElement("div");
            userMsgDiv.classList.add('user-message'); // Style user message
            userMsgDiv.textContent = input; // Display user input text
            messageContainer.appendChild(userMsgDiv); // Add to the container

            // --- Display Bot "Typing..." message ---
            const botLoadingDiv = document.createElement("div");
            botLoadingDiv.classList.add('bot-message'); // Style bot message
            botLoadingDiv.textContent = "GlamBot: Typing...";
            messageContainer.appendChild(botLoadingDiv); // Add to the container

            // --- Scroll to bottom ---
            messageContainer.scrollTop = messageContainer.scrollHeight;

            // --- Fetch response from backend ---
            fetchGeminiResponse(input)
                .then(reply => {
                    // Update the "Typing..." div with the actual reply
                    botLoadingDiv.textContent = "GlamBot: " + reply;
                    // Scroll to bottom again in case the reply is long or causes reflow
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                })
                .catch(error => {
                    botLoadingDiv.textContent = "GlamBot: Sorry, something went wrong.";
                    console.error("Error fetching Gemini response:", error);
                    // Scroll to bottom again
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                });
        }

        // --- Dragging Functionality ---
        let isDragging = false;
        let startX, startY, initialX, initialY;

        dragArea.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX;
            startY = e.clientY;
            initialX = chatWidget.offsetLeft;
            initialY = chatWidget.offsetTop;
            dragArea.style.cursor = 'grabbing'; // Change cursor while dragging
            // Prevent text selection during drag
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            chatWidget.style.left = `${initialX + dx}px`;
            chatWidget.style.top = `${initialY + dy}px`;
        });

        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                dragArea.style.cursor = 'move'; // Restore cursor
            }
        });
         // Prevent drag initiation from interfering with other elements
        dragArea.ondragstart = () => false;


        // --- Function to Fetch Response from Your Backend ---
        // IMPORTANT: This assumes you have a backend server running
        // at http://localhost:3000/api/chat that accepts POST requests
        // with a JSON body like { "question": "user's query" }
        // and returns JSON like { "response": "bot's answer" }
        async function fetchGeminiResponse(prompt) {
            console.log("Sending to backend:", prompt); // Debug log
            try {
                // Make sure this URL matches your backend endpoint
                const response = await fetch('http://localhost:3000/api/chat', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ question: prompt })
                });

                if (!response.ok) {
                    // Log more details on HTTP error
                    const errorBody = await response.text();
                    console.error(`HTTP error! status: ${response.status}`, errorBody);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                             
                const data = await response.json();
                console.log("Received from backend:", data); // Debug log
                // Ensure your backend sends response in data.response
                return data.response || "Sorry, I received an empty response.";

            } catch (error) {
                console.error("Client fetch error:", error);
                // Provide a more user-friendly error message
                return "Oops! I couldn't connect to GlamBot right now. Please try again later.";
            }
        }

    </script>
</body>
</html>